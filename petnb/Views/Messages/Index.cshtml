@using Microsoft.AspNetCore.Http
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
@{
    var token = HttpContextAccessor.HttpContext.Session.GetString("FirebaseToken");
    var Conversations = ViewBag.Conversations;
    var messageIndex = 0;
}


<div class="grid-container" style="height: 77vh;">
    <div class="filter">
        @{int i = 0;}
        @foreach (var Conversation in Conversations)
        {
            <div class="person-message" ng-click="messageIndex = i">
                <div class="profile-picture-message">
                    <p>@Conversation.MessageReceiver</p>
                </div>
            </div>
            i++;
        }
    </div>
    <div class="messages-placeholder">
        @foreach (var message in Conversations[messageIndex].Messages)
        {
            @if (message.IsReceiverMessage)
            {
                <div>
                    <p class="left"><img src="https://cdn.images.express.co.uk/img/dynamic/11/590x/KKSKS-717334.jpg" class="message-picture"/>@message.MessageText</p>
                </div>
            }
            else
            {
                <div>
                    <p class="message-right">@message.MessageText<img src="https://content-static.upwork.com/uploads/2014/10/01073427/profilephoto1.jpg" class="message-picture" /></p>
                </div>
            }
        }

        <div class="message-input-placeholder">
            <input class="message-input-field-text" type="text"/>
            <button id="sendMsg" type="submit" class="message-send-btn">
                <svg class="svgIcon" height="28px" width="26px" version="1.1" viewBox="0 0 16 16" x="0px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" y="0px">
                <path d="M11,8.3L2.6,8.8C2.4,8.8,2.3,8.9,2.3,9l-1.2,4.1c-0.2,0.5,0,1.1,0.4,1.5C1.7,14.9,2,15,2.4,15c0.2,0,0.4,0,0.6-0.1l11.2-5.6 C14.8,9,15.1,8.4,15,7.8c-0.1-0.4-0.4-0.8-0.8-1L3,1.1C2.5,0.9,1.9,1,1.5,1.3C1,1.7,0.9,2.3,1.1,2.9L2.3,7c0,0.1,0.2,0.2,0.3,0.2 L11,7.7c0,0,0.3,0,0.3,0.3S11,8.3,11,8.3z" fill="#65C2AD">
                </path>
                </svg>
            </button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/5.10.0/firebase.js"></script>

<div>
    <div></div>
</div>
<script>

   




    // Initialize Firebase
    var config = {
        apiKey: "AIzaSyCoKatVz8xlteNJGwY5hg_tDWEQ36foOGI",
        authDomain: "frontend-69cae.firebaseapp.com",
        databaseURL: "https://frontend-69cae.firebaseio.com",
        projectId: "frontend-69cae",
        storageBucket: "frontend-69cae.appspot.com",
        messagingSenderId: "574904259542"
    };
    firebase.initializeApp(config);

    var token = "@Html.Raw(token)";
    console.log(token)

    //var user = firebase.auth().currentUser;
    //if (user == null) {

     //to be put here the logic for login.
       
    
    //}


    function signIn() {
        firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION)
            .then(function() {
                // Existing and future Auth states are now persisted in the current
                // session only. Closing the window would clear any existing state even
                // if a user forgets to sign out.
                // ...
                // New sign-in will be persisted with session persistence.
                return firebase.auth().signInWithCustomToken(token);
            })
            .catch(function(error) {
                // Handle Errors here.
                var errorCode = error.code;
                var errorMessage = error.message;
            });
    }



    function returnThread (uid1, uid2)
    {

        if (uid1 < uid2) {
            return uid1+uid2;  
        }
        else{
            return uid2+uid1;
        }
    }

</script>


<noscript>
    firebase.auth().signInWithCustomToken(token).catch(function(error) {
        // Handle Errors here.
        var errorCode = error.code;
        var errorMessage = error.message;
        console.log(errorMessage);
        console.log("succ");
        // ...
    }).then(function() {
        console.log(firebase.auth().currentUser);


        const id1 = "adrian";
        const id2 = "guillem";
        //  const messagesRef = firebase.database().ref(`Messages/Thread/${returnThread(id1, id2)}`);
        const messagesRef = firebase.database().ref('Messages/Thread/');
        var something = {
            message: "nasrat",
            time: new Date().toDateString(),
            sender: firebase.auth().currentUser.uid

        }

        messagesRef.push(something);
        var test = messagesRef.child("adrianguillem")
        console.log(test);

        messagesRef.child("adrianguillem").once('value', function(snapshot) {
            if (snapshot.exists()) {
                alert('exists');
            }
        });
        //messagesRef.orderByKey.equalTo(returnThread(id1, id2)).once("value",
        //    snapshot => {
        //        if (snapshot.exists()) {
        //            const userData = snapshot.val();
        //            console.log("exists!", userData);
        //        } else {
        //            console.log("kokote")
        //        }
        //    });

    });
</noscript>